<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CRUD</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
    crossorigin="anonymous"></script>

</head>

<body>

  <header></header>

  <main class="container my-3">
    <form action="" method="post" id="form-producto" autocomplete="off">

      <input type="hidden" id="idproducto" name="idproducto">


      <div class="card">
        <div class="card-header">
          <strong>Complete los datos solicitados</strong>
        </div> <!-- ./card-header -->
        <div class="card-body">
          <div class="row">
            <div class="col-12 mb-2">
              <div class="form-floating">
                <input type="text" class="form-control rounded-0" id="descripcion" name="descripcion" required>
                <label for="descripcion">Descripción</label>
              </div>
            </div>
          </div>

          <div class="row g-2">
            <div class="col-md-6">
              <div class="form-floating">
                <select name="garantia" id="garantia" class="form-select rounded-0" required>
                  <option value="">Seleccione</option>
                  <option value="0">Sin garantía</option>
                  <option value="3">3 Meses</option>
                  <option value="6">6 Meses</option>
                  <option value="12">1 año</option>
                  <option value="24">2 años</option>
                  <option value="36">3 años</option>
                </select>
                <label for="garantia">Garantía</label>
              </div>
            </div>

            <div class="col-md-6">
              <div class="form-floating">
                <input type="text" name="precio" id="precio" pattern="[0-9.]+" title="Solo se permiten números"
                  class="form-control rounded-0 text-end" required>
                <label for="precio">Precio</label>
              </div>
            </div>
          </div>
        </div>
        <div class="card-footer text-end">
          <button type="reset" class="btn rounded-0 btn-outline-secondary" id="btnCancelar">Cancelar</button>
          <button type="submit" class="btn rounded-0 btn-primary" id="btnGuardar">Guardar</button>
        </div> <!-- ./card-footer -->
      </div>
    </form>

    <style>
      .table tbody tr td:nth-child(4) {
        text-align: right;
      }

      .table tbody tr td:nth-child(1),
      td:nth-child(3),
      td:nth-child(5) {
        text-align: center;
      }
    </style>



    <div class="table-responsive mt-3">
      <table class="table table-bordered" id="tabla-productos">
        <colgroup>
          <col style="width: 10%;">
          <col style="width: 40%;">
          <col style="width: 15%;">
          <col style="width: 15%;">
          <col style="width: 20%;">
        </colgroup>
        <thead>
          <tr>
            <th class="text-center">ID</th>
            <th>descripción</th>
            <th>Garantía</th>
            <th>Precio</th>
            <th class="text-center">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <!-- Datos asíncronos -->
        </tbody>
      </table>
    </div>
  </main>

  <footer></footer>

  <script>
    const API_URL = 'http://localhost:3000/api/productos'

    const formulario = document.getElementById('form-producto')
    const tabla = document.querySelector('#tabla-productos tbody')

    const idproducto = document.getElementById('idproducto')
    const descripcion = document.getElementById('descripcion')
    const garantia = document.getElementById('garantia')
    const precio = document.getElementById('precio')

    const btnGuardar = document.getElementById('btnGuardar')
    const btnCancelar = document.getElementById('btnCancelar')

    btnCancelar.addEventListener('click', () => {
      btnGuardar.innerText = 'Guardar'
    })

    //Obtener los datos (backend) > renderizar en la tabla
    async function obtenerProductos() {
      const response = await fetch(API_URL, { method: 'get' })
      const productos = await response.json()
      //console.log(productos)

      //Reiniciamos el contenido de la tabla
      tabla.innerHTML = '';

      productos.forEach(producto => {
        //Crear una nueva fila y celdas con los datos contenidos en JSON
        const row = tabla.insertRow() //<tr></tr>

        row.insertCell().textContent = producto.id //<td></td>
        row.insertCell().textContent = producto.descripcion //<td></td>
        row.insertCell().textContent = producto.garantia //<td></td>
        row.insertCell().textContent = producto.precio //<td></td>

        //La ultima celda contendrá 2 botones (funcionalidad)
        const actionCell = row.insertCell()

        // Botón 1: Editar
        const editButton = document.createElement('button')
        editButton.textContent = 'Editar'
        editButton.classList.add('btn', 'btn-info', 'me-2') // Agregamos margen a la derecha
        editButton.onclick = () => cargarParaEdicion(producto)

        // Botón 2: Eliminar
        const deleteButton = document.createElement('button')
        deleteButton.textContent = 'Eliminar'
        deleteButton.classList.add('btn', 'btn-danger')
        deleteButton.onclick = () => eliminarProducto(producto.id, producto.descripcion)

        // Agregamos ambos botones a la celda
        actionCell.appendChild(editButton)
        actionCell.appendChild(deleteButton)

      });
    }

    async function eliminarProducto(id, descripcion) {
      //console.log(id, descripcion)
      if (confirm(`¿Está seguro de eliminar el producto: ${descripcion}?`)) {
        try {
          const response = await fetch(API_URL + `/${id}`, { method: 'delete' })

          if (!response.ok) {
            throw new Error(`Error al eliminar: ${descripcion}`)
          }

          //Eliminado correctamente...
          const result = await response.json()
          console.log(result)
          obtenerProductos()

        } catch (e) {
          console.log(e)
        }
      }
    }

    async function cargarParaEdicion(producto) {
      idproducto.value = producto.id
      descripcion.value = producto.descripcion
      garantia.value = producto.garantia
      precio.value = producto.precio

      btnGuardar.innerText = 'Actualizar'
    }

    //Al pulsar el botón Guardar(submit) - DEBEMOS VERIFICAR SI: registrar | actualizar
    formulario.addEventListener("submit", async (event) => {
      event.preventDefault() //Anulado el evento submit

      //Para guardar, necesitamos almacenar los datos en formato JSON
      //Preparamos un objeto con la misma estructura

      const data = {
        descripcion: descripcion.value,
        garantia: parseInt(garantia.value),
        precio: parseFloat(precio.value)
      }

      //Enviar los datos (1.- URL, 2.- Verbo, 3.- Tipo de dato, 4.- JSON)
      try {

        //¿Actualizamos o registramos?
        let response = null

        if (idproducto.value == '') {
          response = await fetch(API_URL, {
            method: 'post',
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
          })
        } else {
          //Actualizar...!
          response = await fetch(API_URL + `/${idproducto.value}`, {
            method: 'put',
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
          })
        }

        const result = await response.json()
        console.log(result)
        formulario.reset()
        obtenerProductos()
      } catch (e) {
        console.error(e)
      }
    })

    //Cuando la página esté lista, se ejecutará obtenerProductos
    document.addEventListener('DOMContentLoaded', obtenerProductos)
  </script>

</body>

</html>